// Generated by CoffeeScript 1.7.1
var animate, isNumber, loadTrajectoryFile, loadTrajectoryString, togglePlay;

window.playback = {};

playback.possible_states = ['NOT_LOADED', 'LOADING', 'LOADED', 'PLAYING', 'STOPPED', 'DONE_PLAYING'];

playback.state = 'NOT_LOADED';

playback.filename = null;

window.param = 150 / 200;

window.param2 = 30;

loadTrajectoryString = function(allText, callback) {
  var allTextLines, data, delimiter, headers, line, n, this_many, _i, _len;
  if ((callback == null) && (typeof parent_callback !== "undefined" && parent_callback !== null)) {
    callback = parent_callback;
  }
  allText = allText.replace('\r\n', '\n');
  allText = allText.replace('\n\r', '\n');
  allTextLines = allText.split('\n');
  delimiter = /[ \t,]+/;
  headers = allTextLines.shift().split(delimiter);
  if (isNumber(headers[0])) {
    this_many = headers.length - 1;
    allTextLines.unshift(headers.join(' '));
    headers = "RHY RHR RHP RKN RAP RAR LHY LHR LHP LKN LAP LAR RSP RSR RSY REB RWY RWR RWP LSP LSR LSY LEB LWY LWR LWP NKY NK1 NK2 WST RF1 RF2 RF3 RF4 RF5 LF1 LF2 LF3 LF4 LF5";
    headers = headers.split(delimiter);
    headers = headers.slice(0, +this_many + 1 || 9e9);
  }
  data = [];
  for (_i = 0, _len = allTextLines.length; _i < _len; _i++) {
    line = allTextLines[_i];
    line = line.trim();
    if (line !== "") {
      data.push((function() {
        var _j, _len1, _ref, _results;
        _ref = line.split(delimiter);
        _results = [];
        for (_j = 0, _len1 = _ref.length; _j < _len1; _j++) {
          n = _ref[_j];
          _results.push(parseFloat(n));
        }
        return _results;
      })());
    }
  }
  return callback(headers, data);
};

loadTrajectoryFile = function(filename, callback) {
  console.log('loadTrajectory');
  return $.ajax({
    type: "GET",
    url: filename,
    dataType: "text",
    success: function(data) {
      return loadTrajectoryString(data, callback);
    }
  });
};

togglePlay = function() {
  if (playback.footMatrix == null) {
    playback.footMatrix = new THREE.Matrix4;
    playback.footMatrix.copy(hubo.links.Body_RAR.matrixWorld);
  }
  if (playback.state === 'DONE_PLAYING') {
    playback.frame = 0;
  }
  switch (playback.state) {
    case 'LOADED':
    case 'STOPPED':
    case 'DONE_PLAYING':
      playback.state = 'PLAYING';
      playback.startedTime = window.performance.now() - playback.frame / playback.framerate * 1000;
      window.setTimeout(animate, 1);
      window.numframes = 0;
      break;
    case 'PLAYING':
      playback.state = 'STOPPED';
  }
};

animate = function(timestamp) {
  var a, b, delta, delta_post, i, j, process_time, prop, tmp, _i, _j, _ref, _ref1, _ref2, _ref3;
  if (timestamp == null) {
    timestamp = window.performance.now();
  }
  stats.begin();
  if (playback.state !== 'PLAYING') {
    return;
  }
  playback.lastframe = playback.frame;
  delta = timestamp - playback.startedTime;
  playback.frame = Math.round(delta * playback.framerate / 1000);
  if (playback.frame >= playback.data.length) {
    playback.state = 'DONE_PLAYING';
    return;
  }
  for (prop in playback.working_headers) {
    i = playback.working_headers[prop];
    if (prop.slice(0, 2) === "LF" || prop.slice(0, 2) === "RF") {
      tmp = 0;
      for (j = _i = _ref = playback.lastframe + 1, _ref1 = playback.frame; _ref <= _ref1 ? _i <= _ref1 : _i >= _ref1; j = _ref <= _ref1 ? ++_i : --_i) {
        tmp += playback.data[j][i];
      }
      tmp /= playback.framerate;
      hubo.motors[prop].value -= tmp / window.param;
    } else if ((prop.slice(0, 3) === "NK1") || (prop.slice(0, 3) === "NK2")) {
      tmp = 0;
      for (j = _j = _ref2 = playback.lastframe + 1, _ref3 = playback.frame; _ref2 <= _ref3 ? _j <= _ref3 : _j >= _ref3; j = _ref2 <= _ref3 ? ++_j : --_j) {
        tmp += playback.data[j][i];
      }
      tmp *= window.param2;
      hubo.motors[prop].value = 0;
    } else {
      hubo.motors[prop].value = playback.data[playback.frame][i];
    }
  }
  a = new THREE.Matrix4;
  a.getInverse(hubo.links.Body_RAR.matrixWorld);
  b = new THREE.Matrix4;
  b.multiplyMatrices(a, playback.footMatrix);
  hubo.links.Body_Torso.applyMatrix(b);
  delta_post = window.performance.now() - playback.startedTime;
  process_time = delta_post - delta;
  window.numframes++;
  c.render();
  stats.end();
  window.setTimeout(animate, 1);
};

isNumber = function(n) {
  return !isNaN(parseFloat(n)) && isFinite(n);
};

//# sourceMappingURL=data:application/json;base64,ewogICJ2ZXJzaW9uIjogMywKICAiZmlsZSI6ICIvZXhhbXBsZXMvdHJhamVjdG9yeV9wbGF5YmFjay90cmFqZWN0b3J5X3BsYXliYWNrLmpzIiwKICAic291cmNlUm9vdCI6ICIiLAogICJzb3VyY2VzIjogWwogICAgIi9leGFtcGxlcy90cmFqZWN0b3J5X3BsYXliYWNrL3RyYWplY3RvcnlfcGxheWJhY2suanMuY29mZmVlIgogIF0sCiAgIm5hbWVzIjogW10sCiAgIm1hcHBpbmdzIjogIjtBQUdBLElBQUEsdUVBQUE7O0FBQUEsTUFBTSxDQUFDLFFBQVAsR0FBa0IsRUFBbEIsQ0FBQTs7QUFBQSxRQUNRLENBQUMsZUFBVCxHQUNJLENBQUUsWUFBRixFQUNFLFNBREYsRUFFRSxRQUZGLEVBR0UsU0FIRixFQUlFLFNBSkYsRUFLRSxjQUxGLENBRkosQ0FBQTs7QUFBQSxRQVNRLENBQUMsS0FBVCxHQUFpQixZQVRqQixDQUFBOztBQUFBLFFBVVEsQ0FBQyxRQUFULEdBQW9CLElBVnBCLENBQUE7O0FBQUEsTUFZTSxDQUFDLEtBQVAsR0FBZSxHQUFBLEdBQUksR0FabkIsQ0FBQTs7QUFBQSxNQWFNLENBQUMsTUFBUCxHQUFnQixFQWJoQixDQUFBOztBQUFBLG9CQWtCQSxHQUF1QixTQUFDLE9BQUQsRUFBVSxRQUFWLEdBQUE7QUFDbkIsTUFBQSxvRUFBQTtBQUFBLEVBQUEsSUFBUSxrQkFBSixJQUFrQixvRUFBdEI7QUFDSSxJQUFBLFFBQUEsR0FBVyxlQUFYLENBREo7R0FBQTtBQUFBLEVBR0EsT0FBQSxHQUFVLE9BQU8sQ0FBQyxPQUFSLENBQWdCLE1BQWhCLEVBQXVCLElBQXZCLENBSFYsQ0FBQTtBQUFBLEVBSUEsT0FBQSxHQUFVLE9BQU8sQ0FBQyxPQUFSLENBQWdCLE1BQWhCLEVBQXVCLElBQXZCLENBSlYsQ0FBQTtBQUFBLEVBS0EsWUFBQSxHQUFlLE9BQU8sQ0FBQyxLQUFSLENBQWMsSUFBZCxDQUxmLENBQUE7QUFBQSxFQU9BLFNBQUEsR0FBWSxTQVBaLENBQUE7QUFBQSxFQVNBLE9BQUEs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QUFBLEVBbURBLE1BQU0sQ0FBQyxTQUFQLEVBbkRBLENBQUE7QUFBQSxFQXFEQSxDQUFDLENBQUMsTUFBRixDQUFBLENBckRBLENBQUE7QUFBQSxFQXVEQSxLQUFLLENBQUMsR0FBTixDQUFBLENBdkRBLENBQUE7QUFBQSxFQXlEQSxNQUFNLENBQUMsVUFBUCxDQUFrQixPQUFsQixFQUEyQixDQUEzQixDQXpEQSxDQURNO0FBQUEsQ0ExRVYsQ0FBQTs7QUFBQSxRQTBJQSxHQUFXLFNBQUMsQ0FBRCxHQUFBO0FBQ1QsU0FBTyxDQUFBLEtBQUMsQ0FBTSxVQUFBLENBQVcsQ0FBWCxDQUFOLENBQUQsSUFBeUIsUUFBQSxDQUFTLENBQVQsQ0FBaEMsQ0FEUztBQUFBLENBMUlYLENBQUEiLAogICJzb3VyY2VzQ29udGVudCI6IFsKICAgICIjXG4jIEdMT0JBTFNcbiNcbndpbmRvdy5wbGF5YmFjayA9IHt9XG5wbGF5YmFjay5wb3NzaWJsZV9zdGF0ZXMgPSBcbiAgICBbICdOT1RfTE9BREVEJ1xuICAgICwgJ0xPQURJTkcnXG4gICAgLCAnTE9BREVEJ1xuICAgICwgJ1BMQVlJTkcnXG4gICAgLCAnU1RPUFBFRCdcbiAgICAsICdET05FX1BMQVlJTkcnXG4gICAgXVxucGxheWJhY2suc3RhdGUgPSAnTk9UX0xPQURFRCdcbnBsYXliYWNrLmZpbGVuYW1lID0gbnVsbFxuXG53aW5kb3cucGFyYW0gPSAxNTAvMjAwXG53aW5kb3cucGFyYW0yID0gMzBcblxuI1xuIyBGVU5DVElPTlNcbiNcbmxvYWRUcmFqZWN0b3J5U3RyaW5nID0gKGFsbFRleHQsIGNhbGxiYWNrKSAtPiAgXG4gICAgaWYgKG5vdCBjYWxsYmFjaz8gYW5kIHBhcmVudF9jYWxsYmFjaz8pIFxuICAgICAgICBjYWxsYmFjayA9IHBhcmVudF9jYWxsYmFja1xuICAgICMgU3BsaXQgYnkgbGluZVxuICAgIGFsbFRleHQgPSBhbGxUZXh0LnJlcGxhY2UoJ1xcclxcbicsJ1xcbicpICMgRml4IERPU1xuICAgIGFsbFRleHQgPSBhbGxUZXh0LnJlcGxhY2UoJ1xcblxccicsJ1xcbicpICMgRml4IE1hY1xuICAgIGFsbFRleHRMaW5lcyA9IGFsbFRleHQuc3BsaXQoJ1xcbicpXG4gICAgIyBTcGxpdCBieSBkZWxpbWl0ZXJcbiAgICBkZWxpbWl0ZXIgPSAvWyBcXHQsXSsvO1xuICAgICMgR3JhYiBoZWFkZXIgKGZpcnN0IGxpbmUpXG4gICAgaGVhZGVycyA9IGFsbFRleHRMaW5lcy5zaGlmdCgpLnNwbGl0KGRlbGltaXRlcikgIyBSZW1vdmUgZmlyc3QgbGluZSwgc3BsaXQgYnkgc3BhY2VzIGFuZCB0YWJzXG4gICAgIyBUT0RPOiBSZW1vdmUgdGhpcyBcImNvbnZlbmllbmNlXCIgaGFjayBmb3IgdHJhamVjdG9yaWVzIHdpdGggdW5sYWJlbGVkIGhlYWRlcnNcbiAgICBpZiBpc051bWJlcihoZWFkZXJzWzBdKVxuICAgICAgICB0aGlzX21hbnkgPSBoZWFkZXJzLmxlbmd0aCAtIDFcbiAgICAgICAgIyBXaG9vb3BzLCBpdCBhaW4ndCBubyBoZWFkZXIuIFB1dCBpdCBiYWNrLiBcbiAgICAgICAgYWxsVGV4dExpbmVzLnVuc2hpZnQoaGVhZGVycy5qb2luKCcgJykpXG4gICAgICAgICMgTGV0J3MgdXNlIHRoZXNlIHZhbHVlcyBpbnN0ZWFkLlxuICAgICAgICBoZWFkZXJzID0gXCJSSFkgUkhSIFJIUCBSS04gUkFQIFJBUiBMSFkgTEhSIExIUCBMS04gTEFQIExBUiBSU1AgUlNSIFJTWSBSRUIgUldZIFJXUiBSV1AgTFNQIExTUiBMU1kgTEVCIExXWSBMV1IgTFdQIE5LWSBOSzEgTksyIFdTVCBSRjEgUkYyIFJGMyBSRjQgUkY1IExGMSBMRjIgTEYzIExGNCBMRjVcIlxuICAgICAgICBoZWFkZXJzID0gaGVhZGVycy5zcGxpdChkZWxpbWl0ZXIpXG4gICAgICAgIGhlYWRlcnMgPSBoZWFkZXJzWzAuLnRoaXNfbWFueV0gIyBUcmltIG9mZiB1bnVzZWQgaGVhZGVycywgb2Z0ZW4gdGhlIGZpbmdlcnMuXG4gICAgIyBHcmFiIHJlbWFpbmluZyBsaW5lcyBhbmQgY29udmVydCB0byBudW1iZXJzXG4gICAgZGF0YSA9IFtdXG4gICAgZm9yIGxpbmUgaW4gYWxsVGV4dExpbmVzXG4gICAgICAgIGxpbmUgPSBsaW5lLnRyaW0oKVxuICAgICAgICBpZiBsaW5lICE9IFwiXCIgIyBza2lwIGVtcHR5IGxpbmVzXG4gICAgICAgICAgICBkYXRhLnB1c2ggKHBhcnNlRmxvYXQobikgZm9yIG4gaW4gbGluZS5zcGxpdChkZWxpbWl0ZXIpKVxuICAgICMgUmV0dXJuIHRoZSBoZWFkZXJzIGFuZCB0aGUgZGF0YVxuICAgIGNhbGxiYWNrIGhlYWRlcnMsZGF0YVxuXG5sb2FkVHJhamVjdG9yeUZpbGUgPSAoZmlsZW5hbWUsIGNhbGxiYWNrKSAtPlxuICAgICMgTm93IGxvYWQgdGhlIHRyYWplY3RvcnkgZmlsZVxuICAgIGNvbnNvbGUubG9nICdsb2FkVHJhamVjdG9yeSdcbiAgICAkLmFqYXhcbiAgICAgICAgdHlwZTogXCJHRVRcIlxuICAgICAgICB1cmw6IGZpbGVuYW1lXG4gICAgICAgIGRhdGFUeXBlOiBcInRleHRcIlxuICAgICAgICBzdWNjZXNzOiAoZGF0YSkgLT4gXG4gICAgICAgICAgICBsb2FkVHJhamVjdG9yeVN0cmluZyhkYXRhLCBjYWxsYmFjaylcblxudG9nZ2xlUGxheSA9ICgpIC0+XG4gICAgaWYgbm90IHBsYXliYWNrLmZvb3RNYXRyaXg/XG4gICAgICAgIHBsYXliYWNrLmZvb3RNYXRyaXggPSBuZXcgVEhSRUUuTWF0cml4NFxuICAgICAgICBwbGF5YmFjay5mb290TWF0cml4LmNvcHkoaHViby5saW5rcy5Cb2R5X1JBUi5tYXRyaXhXb3JsZClcblxuICAgIGlmIHBsYXliYWNrLnN0YXRlID09ICdET05FX1BMQVlJTkcnIHRoZW4gcGxheWJhY2suZnJhbWUgPSAwXG4gICAgc3dpdGNoIHBsYXliYWNrLnN0YXRlICAgIFxuICAgICAgICB3aGVuICdMT0FERUQnLCAnU1RPUFBFRCcsICdET05FX1BMQVlJTkcnXG4gICAgICAgICAgICBwbGF5YmFjay5zdGF0ZSA9ICdQTEFZSU5HJ1xuICAgICAgICAgICAgcGxheWJhY2suc3RhcnRlZFRpbWUgPSB3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLSBwbGF5YmFjay5mcmFtZS9wbGF5YmFjay5mcmFtZXJhdGUqMTAwMCAjIG1zXG4gICAgICAgICAgICAjcmVxdWVzdEFuaW1hdGlvbkZyYW1lKCBhbmltYXRlIClcbiAgICAgICAgICAgIHdpbmRvdy5zZXRUaW1lb3V0KGFuaW1hdGUsIDEpXG4gICAgICAgICAgICB3aW5kb3cubnVtZnJhbWVzID0gMFxuICAgICAgICB3aGVuICdQTEFZSU5HJ1xuICAgICAgICAgICAgcGxheWJhY2suc3RhdGUgPSAnU1RPUFBFRCdcbiAgICByZXR1cm5cblxuYW5pbWF0ZSA9ICh0aW1lc3RhbXApIC0+XG4gICAgaWYgbm90IHRpbWVzdGFtcD9cbiAgICAgICAgdGltZXN0YW1wID0gd2luZG93LnBlcmZvcm1hbmNlLm5vdygpXG4gICAgIyBVcGRhdGUgRlBTIC0gVE9ETzogRmlndXJlIG91dCBob3cgdG8gbWFrZSB0aGlzIGFnbm9zdGljLiBXaGF0IGlmIHVzZXJzIGRvbid0IHdhbnQgRlBTIG1vbml0b3I/XG4gICAgc3RhdHMuYmVnaW4oKVxuICAgIGlmIChwbGF5YmFjay5zdGF0ZSAhPSAnUExBWUlORycpXG4gICAgICAgIHJldHVyblxuICAgICMgdGltZXN0YW1wIGlzIGEgZmxvYXRpbmcgcG9pbnQgbWlsbGVzZWNvbmRzIGluIHJlY2VudCBDaHJvbWUgLyBGaXJlZm94XG4gICAgIyBDYWxjdWxhdGUgdGltZSBkZWx0YSBhbmQgYW5pbWF0aW9uIGZyYW1lIHRvIHVzZVxuICAgIHBsYXliYWNrLmxhc3RmcmFtZSA9IHBsYXliYWNrLmZyYW1lXG4gICAgZGVsdGEgPSB0aW1lc3RhbXAgLSBwbGF5YmFjay5zdGFydGVkVGltZVxuICAgIHBsYXliYWNrLmZyYW1lID0gTWF0aC5yb3VuZChkZWx0YSpwbGF5YmFjay5mcmFtZXJhdGUvMTAwMClcbiAgICBpZiBwbGF5YmFjay5mcmFtZSA+PSBwbGF5YmFjay5kYXRhLmxlbmd0aFxuICAgICAgICBwbGF5YmFjay5zdGF0ZSA9ICdET05FX1BMQVlJTkcnXG4gICAgICAgIHJldHVyblxuICAgICMgVXBkYXRlIGFsbCBqb2ludHNcbiAgICBmb3IgcHJvcCBvZiBwbGF5YmFjay53b3JraW5nX2hlYWRlcnNcbiAgICAgICAgaSA9IHBsYXliYWNrLndvcmtpbmdfaGVhZGVyc1twcm9wXVxuICAgICAgICAjIEZpbmdlcnMgYW5kIG5lY2sgYXJlLi4uIHN0cmFuZ2UuIFZlbG9jaXR5IGNvbnRyb2wgb3IgY3VycmVudCBjb250cm9sIG9yIHNvbWV0aGluZy5cbiAgICAgICAgaWYgcHJvcFswLi4xXSA9PSBcIkxGXCIgb3IgcHJvcFswLi4xXSA9PSBcIlJGXCJcbiAgICAgICAgICAgICMgSW50ZWdyYXRlIHRoZSBkYXRhIGluIGJldHdlZW4gdGhlIGxhc3QgZnJhbWUgYW5kIG5vd1xuICAgICAgICAgICAgdG1wID0gMFxuICAgICAgICAgICAgZm9yIGogaW4gW3BsYXliYWNrLmxhc3RmcmFtZSsxIC4uIHBsYXliYWNrLmZyYW1lXVxuICAgICAgICAgICAgICAgIHRtcCArPSBwbGF5YmFjay5kYXRhW2pdW2ldXG4gICAgICAgICAgICB0bXAgLz0gcGxheWJhY2suZnJhbWVyYXRlXG4gICAgICAgICAgICAjIEFwcGx5IHRvIGZpbmdlciB2YWx1ZVxuICAgICAgICAgICAgaHViby5tb3RvcnNbcHJvcF0udmFsdWUgLT0gdG1wIC8gd2luZG93LnBhcmFtXG4gICAgICAgIGVsc2UgaWYgKHByb3BbMC4uMl0gPT0gXCJOSzFcIikgb3IgKHByb3BbMC4uMl0gPT0gXCJOSzJcIilcbiAgICAgICAgICAgICMgSW50ZWdyYXRlIHRoZSBkYXRhIGluIGJldHdlZW4gdGhlIGxhc3QgZnJhbWUgYW5kIG5vd1xuICAgICAgICAgICAgdG1wID0gMFxuICAgICAgICAgICAgZm9yIGogaW4gW3BsYXliYWNrLmxhc3RmcmFtZSsxIC4uIHBsYXliYWNrLmZyYW1lXVxuICAgICAgICAgICAgICAgIHRtcCArPSBwbGF5YmFjay5kYXRhW2pdW2ldXG4gICAgICAgICAgICAjIHRtcCAvPSAxMjggIyAxMjggZW5jb2RlciB0aWNrcyBwZXIgcmV2XG4gICAgICAgICAgICAjIHRtcCAvPSBNYXRoLlBJICMgMW1tIHBpdGNoIHBlciByZXZcbiAgICAgICAgICAgIHRtcCAqPSB3aW5kb3cucGFyYW0yXG4gICAgICAgICAgICAjaHViby5tb3RvcnNbcHJvcF0udmFsdWUgKz0gdG1wXG4gICAgICAgICAgICBodWJvLm1vdG9yc1twcm9wXS52YWx1ZSA9IDAgIyBEaXNhYmxlIGJlY2F1c2UgdGhlIHRyYWplY3RvcnkgZmlsZXMgYXJlIG1pc3NpbmcgTksyLiBPb3BzIVxuICAgICAgICBlbHNlXG4gICAgICAgICAgICBodWJvLm1vdG9yc1twcm9wXS52YWx1ZSA9IHBsYXliYWNrLmRhdGFbcGxheWJhY2suZnJhbWVdW2ldXG4gICAgIyBSb3RhdGUgdGhlIHdob2xlIHNoZWJhbmcgc28gdGhhdCB0aGUgZm9vdCBpcyB0aGUgXCJncm91bmRlZFwiIG9iamVjdC5cbiAgICAjIGZvciBwcm9wIG9mIGh1Ym8ubGlua3NcbiAgICAjICAgICBpZiBodWJvLmxpbmtzW3Byb3BdLmFwcGx5TWF0cml4P1xuICAgICMgICAgICAgICBodWJvLmxpbmtzW3Byb3BdLmFwcGx5TWF0cml4KGh1Ym8ubGlua3MuQm9keV9SQVIubWF0cml4V29ybGQpXG4gICAgYSA9IG5ldyBUSFJFRS5NYXRyaXg0XG4gICAgYS5nZXRJbnZlcnNlKGh1Ym8ubGlua3MuQm9keV9SQVIubWF0cml4V29ybGQpXG4gICAgYiA9IG5ldyBUSFJFRS5NYXRyaXg0XG4gICAgYi5tdWx0aXBseU1hdHJpY2VzKGEscGxheWJhY2suZm9vdE1hdHJpeClcbiAgICBodWJvLmxpbmtzLkJvZHlfVG9yc28uYXBwbHlNYXRyaXgoYilcbiAgICAjIGh1Ym8ubGlua3MuQm9keV9Ub3Jzby5tYXRyaXguZ2V0SW52ZXJzZShodWJvLmxpbmtzLkJvZHlfUkFSLm1hdHJpeFdvcmxkKVxuICAgICMgSSdtIGN1cmlvdXMgaG93IGxvbmcgdGhhdCBwcm9jZXNzIHRha2VzIGFjdHVhbGx5LlxuICAgIGRlbHRhX3Bvc3QgPSB3aW5kb3cucGVyZm9ybWFuY2Uubm93KCkgLSBwbGF5YmFjay5zdGFydGVkVGltZVxuICAgIHByb2Nlc3NfdGltZSA9IGRlbHRhX3Bvc3QgLSBkZWx0YVxuICAgIHdpbmRvdy5udW1mcmFtZXMrK1xuICAgICMgY29uc29sZS5sb2cgXCJGcmFtZTogXCIgKyBwbGF5YmFjay5mcmFtZSArICcgaTogJyArIG51bWZyYW1lc1xuICAgIGMucmVuZGVyKClcbiAgICAjIFVwZGF0ZSBGUFNcbiAgICBzdGF0cy5lbmQoKVxuICAgICNyZXF1ZXN0QW5pbWF0aW9uRnJhbWUoIGFuaW1hdGUgKVxuICAgIHdpbmRvdy5zZXRUaW1lb3V0KGFuaW1hdGUsIDEpXG4gICAgcmV0dXJuXG5cbiNcbiMgSEVMUEVSU1xuI1xuaXNOdW1iZXIgPSAobikgLT5cbiAgcmV0dXJuICFpc05hTihwYXJzZUZsb2F0KG4pKSAmJiBpc0Zpbml0ZShuKVxuIgogIF0KfQ==